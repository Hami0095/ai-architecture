name: Build & Sign ai-architect

on:
  push:
    tags:
      - "v*"

permissions:
  contents: write

jobs:
  build:
    strategy:
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]
    runs-on: ${{ matrix.os }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      # =====================
      # BUILD STEP (replace with Go/Rust/etc)
      # =====================
      - name: Build binary
        run: |
          mkdir -p dist
          echo "placeholder binary" > dist/ai-architect
        shell: bash

      # =====================
      # macOS SIGNING
      # =====================
      - name: macOS Codesign
        if: runner.os == 'macOS'
        env:
          CERT_P12: ${{ secrets.MACOS_CERT_P12 }}
          CERT_PASS: ${{ secrets.MACOS_CERT_PASSWORD }}
          SIGN_ID: ${{ secrets.MACOS_SIGN_IDENTITY }}
        run: |
          echo "$CERT_P12" | base64 --decode > cert.p12
          security create-keychain -p temp build.keychain
          security import cert.p12 -k build.keychain -P "$CERT_PASS" -T /usr/bin/codesign
          security default-keychain -s build.keychain
          security unlock-keychain -p temp build.keychain
          codesign --force --options runtime --sign "$SIGN_ID" dist/ai-architect
          codesign --verify --verbose dist/ai-architect

      # =====================
      # WINDOWS SIGNING
      # =====================
      - name: Windows Authenticode Sign
        if: runner.os == 'Windows'
        shell: pwsh
        env:
          PFX: ${{ secrets.WINDOWS_CERT_PFX }}
          PFX_PASS: ${{ secrets.WINDOWS_CERT_PASSWORD }}
        run: |
          echo $env:PFX | Out-File cert.pfx -Encoding byte
          signtool sign /f cert.pfx /p $env:PFX_PASS /tr http://timestamp.digicert.com /td sha256 /fd sha256 dist\ai-architect

      # =====================
      # LINUX GPG SIGNING
      # =====================
      - name: Linux GPG Sign
        if: runner.os == 'Linux'
        env:
          GPG_KEY: ${{ secrets.GPG_PRIVATE_KEY }}
          GPG_PASS: ${{ secrets.GPG_PASSPHRASE }}
        run: |
          echo "$GPG_KEY" | gpg --batch --import
          gpg --batch --yes --pinentry-mode loopback \
              --passphrase "$GPG_PASS" \
              --output dist/ai-architect.sig \
              --detach-sign dist/ai-architect

      # =====================
      # UPLOAD RELEASE ASSETS
      # =====================
      - name: Upload Release
        uses: softprops/action-gh-release@v2
        with:
          files: dist/*
